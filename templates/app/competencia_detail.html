{% extends 'base.html' %}

{% block title %}{{ competencia.name }} - Resultados{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" style="margin-bottom: 1.5rem;">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'ui:competencia_list' %}">
                <i class="bi-house"></i> Inicio
            </a>
        </li>
        <li class="breadcrumb-item active">{{ competencia.name }}</li>
    </ol>
</nav>

<!-- Header Compacto -->
<div class="card competition-header mb-4">
    <div class="card-body" style="padding: 1.25rem 1.5rem;">
        <h2 style="display: flex; align-items: center; gap: 0.625rem; margin-bottom: 1rem;">
            <i class="bi-trophy-fill" style="color: var(--gold); font-size: 1.5rem;"></i>
            {{ competencia.name }}
            <span id="badge-en-vivo" {% if not en_curso %}style="display:none;"{% else %}style="font-size: 0.75rem; animation: pulse-subtle 2s ease-in-out infinite;"{% endif %} class="badge badge-success">
                <i class="bi-broadcast"></i> EN VIVO
            </span>
        </h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div>
                <div class="stats-label">Fecha y Hora</div>
                <strong style="font-size: 0.875rem; color: var(--text-primary);">
                    {{ competencia.datetime|date:"d M Y, H:i" }}
                </strong>
            </div>
            <div>
                <div class="stats-label">Estado</div>
                <span id="badge-estado">
                    {% if competencia.get_status_code == 'running' %}
                        <span class="badge badge-success" style="font-size: 0.813rem;">
                            <i class="bi-play-circle-fill"></i> En Curso
                        </span>
                    {% elif competencia.get_status_code == 'finished' %}
                        <span class="badge badge-secondary" style="font-size: 0.813rem;">
                            <i class="bi-check-circle-fill"></i> Finalizada
                        </span>
                    {% else %}
                        <span class="badge badge-info" style="font-size: 0.813rem;">
                            <i class="bi-calendar-event"></i> Programada
                        </span>
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Resumen de estadísticas -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.875rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <div class="stats-box" style="padding: 0.75rem;">
                <div class="stats-label">Total Equipos</div>
                <div class="stats-value" id="stat-total-equipos">{{ total_equipos }}</div>
            </div>
            <div class="stats-box" style="padding: 0.75rem;">
                <div class="stats-label">Calificados</div>
                <div class="stats-value text-success" id="stat-equipos-calificados">{{ equipos_calificados }}</div>
            </div>
            <div class="stats-box" style="padding: 0.75rem;">
                <div class="stats-label">Descalificados</div>
                <div class="stats-value text-danger" id="stat-equipos-descalificados">{{ equipos_descalificados }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Filtro por Categoría -->
{% if categorias %}
<div class="card mb-4">
    <div class="card-body" style="padding: 1rem 1.5rem;">
        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="bi-funnel" style="color: var(--primary);"></i>
                <span style="font-weight: 600; font-size: 0.875rem;">Filtrar por categoría:</span>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="{% url 'ui:competencia_detail' competencia.pk %}" 
                   class="btn {% if not categoria_filtro %}btn-primary{% else %}btn-secondary{% endif %}"
                   style="font-size: 0.813rem; padding: 0.375rem 0.75rem;">
                    Todas
                </a>
                {% for cat in categorias %}
                <a href="{% url 'ui:competencia_detail' competencia.pk %}?categoria={{ cat.value }}" 
                   class="btn {% if cat.selected %}btn-primary{% else %}btn-secondary{% endif %}"
                   style="font-size: 0.813rem; padding: 0.375rem 0.75rem;">
                    {{ cat.label }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div id="results-container">
    {% include 'app/partials/competencia_results.html' %}
</div>

<div style="margin-top: 1.5rem;">
    <a href="{% url 'ui:competencia_list' %}" class="btn btn-secondary">
        <i class="bi-arrow-left"></i> Volver
    </a>
</div>

<script>
(() => {
    const competenciaId = {{ competencia.id|default:'null' }};
    if (!competenciaId) return;

    const resultsEl = document.getElementById('results-container');
    if (!resultsEl) return;

    const statTotal = document.getElementById('stat-total-equipos');
    const statCal = document.getElementById('stat-equipos-calificados');
    const statDesc = document.getElementById('stat-equipos-descalificados');

    const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${proto}://${window.location.host}/ws/competencia/${competenciaId}/`;
    const partialBaseUrl = "{% url 'ui:competencia_results_partial' competencia.pk %}";

    let refreshTimer = null;
    let inFlight = false;
    let pending = false;
    let refreshSeq = 0;

    const swapResultsHtml = (html) => {
        const prevHeight = resultsEl.offsetHeight;
        if (prevHeight) resultsEl.style.minHeight = `${prevHeight}px`;

        const tpl = document.createElement('template');
        tpl.innerHTML = html;
        resultsEl.replaceChildren(tpl.content);

        requestAnimationFrame(() => {
            resultsEl.style.minHeight = '';
        });
    };

    const refreshResults = async () => {
        if (inFlight) {
            pending = true;
            return;
        }

        inFlight = true;
        const mySeq = ++refreshSeq;

        try {
            const res = await fetch(`${partialBaseUrl}${window.location.search}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
            });
            if (!res.ok) return;

            const html = await res.text();
            if (mySeq !== refreshSeq) return;

            swapResultsHtml(html);

            const root = resultsEl.querySelector('#results-root');
            if (root) {
                if (statTotal) statTotal.textContent = root.dataset.totalEquipos || statTotal.textContent;
                if (statCal) statCal.textContent = root.dataset.equiposCalificados || statCal.textContent;
                if (statDesc) statDesc.textContent = root.dataset.equiposDescalificados || statDesc.textContent;
            }
        } catch {
            // No romper la UI si el refresco falla momentáneamente.
        } finally {
            inFlight = false;
            if (pending) {
                pending = false;
                scheduleRefresh();
            }
        }
    };

    const scheduleRefresh = () => {
        if (inFlight) {
            pending = true;
            return;
        }

        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(refreshResults, 120);
    };

    const ws = new WebSocket(wsUrl);

    ws.onmessage = (evt) => {
        let msg;
        try { msg = JSON.parse(evt.data); } catch { return; }

        if (msg.tipo === 'registros_actualizados') {
            // Al llegar un equipo nuevo o un mejor tiempo, el ranking puede cambiar.
            scheduleRefresh();
            return;
        }

        if (msg.tipo === 'competencia_iniciada') {
            const badgeVivo = document.getElementById('badge-en-vivo');
            if (badgeVivo) badgeVivo.style.display = '';

            const badgeEstado = document.getElementById('badge-estado');
            if (badgeEstado) {
                badgeEstado.innerHTML = `
                    <span class="badge badge-success" style="font-size: 0.813rem;">
                        <i class="bi-play-circle-fill"></i> En Curso
                    </span>
                `;
            }

            return;
        }

        if (msg.tipo === 'competencia_detenida') {
            const badgeVivo = document.getElementById('badge-en-vivo');
            if (badgeVivo) badgeVivo.style.display = 'none';

            const badgeEstado = document.getElementById('badge-estado');
            if (badgeEstado) {
                badgeEstado.innerHTML = `
                    <span class="badge badge-secondary" style="font-size: 0.813rem;">
                        <i class="bi-check-circle-fill"></i> Finalizada
                    </span>
                `;
            }

            return;
        }
    };

    ws.onopen = () => {
        setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ tipo: 'ping' }));
        }, 25000);
    };
})();
</script>
{% endblock %}